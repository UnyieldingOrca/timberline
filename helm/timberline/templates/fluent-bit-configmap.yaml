{{- if .Values.fluentBit.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "timberline.fluentBit.labels" . | nindent 4 }}
data:
  fluent-bit.yaml: |
    service:
      flush: {{ .Values.fluentBit.config.flush }}
      daemon: off
      log_level: {{ .Values.fluentBit.config.logLevel }}
      parsers_file: parsers.yaml
      http_server: on
      http_listen: 0.0.0.0
      http_port: {{ .Values.fluentBit.config.httpPort }}
      storage.metrics: on
      grace: 30
      health_check: on
      hc_errors_count: 5
      hc_retry_failure_count: 5
      hc_period: 60

    pipeline:
      inputs:
        - name: tail
          path: /var/log/containers/*.log
          path_key: filename
          parser: cri
          tag: kube.*
          refresh_interval: 5
          rotate_wait: 30
          mem_buf_limit: 5MB
          skip_long_lines: on
          skip_empty_lines: on
          read_from_head: false

      filters:
        - name: kubernetes
          match: kube.*
          kube_url: https://kubernetes.default.svc:443
          kube_ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          kube_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
          kube_tag_prefix: kube.var.log.containers.
          k8s-logging.parser: on
          k8s-logging.exclude: {{ if .Values.fluentBit.config.excludeAnnotated }}on{{ else }}off{{ end }}
          annotations: on
          labels: on
          owner_references: off
          namespace_labels: on
          namespace_annotations: on
          merge_log: on
          merge_log_trim: on
          keep_log: off
          buffer_size: 256k

        - name: lua
          match: '*'
          script: /fluent-bit/etc/sampling.lua
          call: subsample_info

      outputs:
        - name: http
          match: '*'
          host: log-ingestor
          port: {{ .Values.logIngestor.config.serverPort }}
          uri: /api/v1/logs/stream
          format: json_lines
          header: Content-Type application/x-ndjson
          retry_limit: 1
          workers: 2
          net.keepalive: on
          net.keepalive_idle_timeout: 30

  sampling.lua: |
    function subsample_info(tag, timestamp, record)
        local log_message = record["log"] or record["message"] or ""
        local log_lower = string.lower(log_message)

        -- Always keep ERROR, FATAL, WARN, PANIC logs
        if string.match(log_lower, "error") or
           string.match(log_lower, "fatal") or
           string.match(log_lower, "warn") or
           string.match(log_lower, "panic") then
            return 1, timestamp, record
        end

        -- For INFO/DEBUG logs, sample based on configured rate
        if string.match(log_lower, "info") or
           string.match(log_lower, "debug") then
            -- Sample based on samplingRate (default 50%)
            if math.random(100) <= {{ .Values.fluentBit.config.samplingRate }} then
                return 1, timestamp, record
            else
                return -1, timestamp, record  -- Drop the record
            end
        end

        -- Keep logs without level indicators at configured rate as well
        if math.random(100) <= {{ .Values.fluentBit.config.samplingRate }} then
            return 1, timestamp, record
        else
            return -1, timestamp, record
        end
    end

  parsers.yaml: |
    parsers:
      - name: json
        format: json
        time_key: time
        time_format: '%Y-%m-%dT%H:%M:%S.%L%z'
        time_keep: on
    
      - name: docker
        format: json
        time_key: time
        time_format: '%Y-%m-%dT%H:%M:%S.%L'
        time_keep: on
      
      - name: cri
        format: regex
        regex: '^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$'
        time_key: time
        time_format: '%Y-%m-%dT%H:%M:%S.%L%z'
{{- end }}
